<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Jemi Manager v4.8 Full Spectrum</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; background: #0f111a; color: #eceff4; }
        
        /* ì‚¬ì´ë“œë°” ê³ ì • ìŠ¤íƒ€ì¼ */
        .sidebar { 
            width: 280px; background: #1a1b26; position: fixed; 
            height: 100vh; border-right: 1px solid #2e3440; 
            padding-top: 20px; overflow-y: auto; z-index: 100;
        }
        .nav-label { padding: 20px 25px 8px; font-size: 11px; color: #4c566a; text-transform: uppercase; font-weight: bold; }
        .nav-item { padding: 10px 40px; cursor: pointer; color: #9ea9c1; font-size: 14px; transition: 0.2s; }
        .nav-item:hover { background: #24283b; color: #82aaff; }
        .nav-item.active { background: #24283b; color: #82aaff; border-right: 3px solid #82aaff; font-weight: bold; }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ (ì‚¬ì´ë“œë°” ë„ˆë¹„ë§Œí¼ ë§ˆì§„ ë¶€ì—¬) */
        .main-content { margin-left: 280px; flex: 1; padding: 40px; min-width: 0; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: #1a1b26; padding: 25px; border-radius: 12px; border: 1px solid #2e3440; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h1 { color: #82aaff; border-bottom: 1px solid #2e3440; padding-bottom: 15px; margin-top: 0; }
        
        /* ë¶„ì„ ë„êµ¬ ìŠ¤íƒ€ì¼ */
        .search-box { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 25px; background: #1a1b26; padding: 20px; border-radius: 12px; border: 1px solid #414868; }
        input { background: #0f111a; border: 1px solid #4c566a; color: #eceff4; padding: 8px 12px; border-radius: 6px; text-align: center; }
        button { background: #82aaff; border: none; color: #1a1b26; padding: 8px 25px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #73daca; transform: translateY(-1px); }

        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 30px; }
        .metric-item { background: #24283b; padding: 12px; border-radius: 8px; border-left: 4px solid #414868; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="text-align:center; color:#82aaff; margin-bottom: 30px;">ğŸ’ JEMI v4.8</h2>
        <div class="nav-label">Dashboard</div>
        <div class="nav-item active" onclick="openTab(event, 'flowchart.md')">Overall Flow</div>
        <div class="nav-item" onclick="openTab(event, 'realtime-chart')">ğŸ“ˆ Market Intelligence</div>
        
        <div class="nav-label">Strategy MD</div>
        {% for f in md_section_files %}
        <div class="nav-item" onclick="openTab(event, '{{ f }}')">â”” {{ f }}</div>
        {% endfor %}
    </div>

    <div class="main-content">
        <div id="flowchart.md" class="tab-content active">
            <h1>STRATEGY FLOW</h1>
            <div class="card"><div class="mermaid">{{ contents['flowchart.md'] }}</div></div>
        </div>

        <div id="realtime-chart" class="tab-content">
            <h1>MARKET TREND ANALYSIS</h1>
            <div class="search-box">
                <div><label style="color:#82aaff; font-size:12px;">TICKER</label><br><input type="text" id="ticker-input" value="005930" style="width:80px; margin-top:5px;"></div>
                <div><label style="color:#82aaff; font-size:12px;">PERIOD</label><br><input type="date" id="start-date" style="margin-top:5px;"> ~ <input type="date" id="end-date" style="margin-top:5px;"></div>
                <div style="margin-top:20px; display:flex; gap:10px;">
                    <button onclick="refreshChart()">ANALYZE</button>
                    <button onclick="saveExcel()" style="background:#73daca;">SAVE EXCEL</button>
                </div>
            </div>
            <div id="result-display" class="card" style="min-height: 500px;">
                <p style="color:#565f89; text-align:center; padding-top:200px;">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ANALYZEë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</p>
            </div>
        </div>

        {% for f, content in contents.items() if f != 'flowchart.md' %}
        <div id="{{ f }}" class="tab-content">
            <h1>{{ f.upper() }}</h1>
            <div class="card"><div id="render-{{ loop.index }}" class="markdown-body">{{ content }}</div></div>
        </div>
        {% endfor %}
    </div>

    <script>
        mermaid.initialize({ theme: 'dark' });

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
            document.getElementById('start-date').value = lastMonth;
            document.getElementById('end-date').value = today;
            // MD ë Œë”ë§
            document.querySelectorAll('.markdown-body').forEach(el => { el.innerHTML = marked.parse(el.innerText); });
        };

        async function refreshChart() {
            const ticker = document.getElementById('ticker-input').value;
            const start = document.getElementById('start-date').value.replace(/-/g, '');
            const end = document.getElementById('end-date').value.replace(/-/g, '');
            const display = document.getElementById('result-display');
            
            display.innerHTML = '<p style="text-align:center; padding-top:200px; color:#82aaff;">ë°ì´í„° ë¶„ì„ ë° ì‹œê°í™” ì¤‘...</p>';

            try {
                const response = await fetch(`/api/chart-data?ticker=${ticker}&start=${start}&end=${end}`);
                const data = await response.json();

                if (data.status === "SUCCESS") {
                    let gridHtml = '';
                    for (const [name, value] of Object.entries(data.last_metrics)) {
                        const valNum = parseFloat(value);
                        const color = valNum > 0 ? '#f7768e' : (valNum < 0 ? '#7aa2f7' : '#9ea9c1');
                        gridHtml += `
                            <div class="metric-item" style="border-left-color: ${color};">
                                <div style="color:#9ea9c1; font-size:11px;">${name}</div>
                                <div style="font-size:16px; font-weight:bold; color:${color};">${valNum > 0 ? '+' : ''}${value}ì–µ</div>
                            </div>`;
                    }

                    display.innerHTML = `
                        <h2 style="color:#73daca; margin-bottom:5px;">âœ… ${data.ticker_name}</h2>
                        <p style="font-size:24px; font-weight:bold; margin-bottom:20px;">ì¢…ê°€: ${data.current_price}</p>
                        <div class="metrics-grid">${gridHtml}</div>
                        <div id="trend-chart" style="width:100%; height:480px;"></div>
                    `;

                    // ìˆ˜ê¸‰ íŠ¸ë ˆì´ìŠ¤ (ì™¼ìª½ ì¶•)
                    const traces = Object.keys(data.trend_data).map(name => ({
                        x: data.dates, y: data.trend_data[name],
                        mode: 'lines', name: name,
                        line: { shape: 'spline', width: 1 }, yaxis: 'y'
                    }));

                    // ì£¼ê°€ íŠ¸ë ˆì´ìŠ¤ (ì˜¤ë¥¸ìª½ ì¶•)
                    traces.push({
                        x: data.dates, y: data.prices,
                        name: 'ì£¼ê°€(ì¢…ê°€)', type: 'scatter', mode: 'lines',
                        line: { color: '#00FFFF', width: 5,shape: 'spline', smoothing: 1.3 },
                        yaxis: 'y2'
                    });

                    const layout = {
                        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#eceff4' }, margin: { t: 40, b: 80, l: 60, r: 60 },
                        hovermode: 'x unified',
                        // ğŸŒŸ ì»¤ì„œ(í˜¸ë²„) íˆ´íŒ ìŠ¤íƒ€ì¼ ì„¤ì • ì‹œì‘
                        hoverlabel: {
                            bgcolor: '#1a1b26',    // íˆ´íŒ ë°°ê²½ìƒ‰ (ì§„í•œ ë‚¨ìƒ‰/ê²€ì •)
                            bordercolor: '#82aaff', // íˆ´íŒ í…Œë‘ë¦¬ìƒ‰ (ë„¤ì˜¨ ë¸”ë£¨)
                            font: { 
                                family: 'Segoe UI', 
                                size: 13, 
                                color: '#ffffff'    // ğŸŒŸ ê¸€ììƒ‰ì„ ìˆœë°±ìƒ‰ìœ¼ë¡œ ê°•ì œ!
                            },
                            align: 'left'
                        },
                        //xaxis: { type: 'date', rangebreaks:[ {bounds: ["sat","sun"]}, {values:["2025-12-25"]}], gridcolor: '#2e3440', zeroline: false },
                        xaxis: { gridcolor: '#2e3440', zeroline: false },
                        yaxis: { title: 'ìˆ˜ê¸‰ (ì–µ ì›)', gridcolor: '#2e3440', zeroline: false },
                        yaxis2: { title: 'ì£¼ê°€ (ì›)', overlaying: 'y', side: 'right', showgrid: false, zeroline: false },
                        legend: { orientation: 'h', y: -0.3 }
                    };

                    Plotly.newPlot('trend-chart', traces, layout, {responsive: true});
                } else {
                    display.innerHTML = `<h2 style="color:#f7768e; text-align:center; padding-top:100px;">âŒ Error: ${data.error_msg}</h2>`;
                }
            } catch (e) { console.error(e); }
        }

        function saveExcel() {
            const ticker = document.getElementById('ticker-input').value;
            const start = document.getElementById('start-date').value.replace(/-/g, '');
            const end = document.getElementById('end-date').value.replace(/-/g, '');
            window.location.href = `/api/save-excel?ticker=${ticker}&start=${start}&end=${end}`;
        }

        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            if (tabName === 'flowchart.md') mermaid.init(undefined, ".mermaid");
        }
    </script>
</body>
</html>